# FRAM Data Warehouse - Client API

Web API documentation, for NOAA North West Fisheries Science Center FRAM data warehouse.

## Overview
The following sections outline the available API features.
* [/source - Data Sources](#data-sources)
* [/login - Sensitive Data](#sensitive-data)
  * [/logout - Sensitive Data (logout)](#logout)
  * [/user - Sensitive Data (user)](#user-info)
  * [/external/login - Sensitive Data (external)](#non-noaa-users)
     * [Login Example](#login-example)
* [/help - API Documentation](#api-documentation)
* [/p3p - Privacy Information](#privacy-information)
* [/csw - OCG Catalog Service (Web)](#ogc-catalog-service-for-the-web-csw)
* [/source/{id}/selection.(json|csv) - Data Selection](#data-selection)
  * [/source/{id}/variables - Data Selection Fields](#available-data-source-variables)
* [/source/{id}/metadata.(xml|iso) - Data Set Metadata](#data-set-metadata)

## Data Sources

Warehoused data sets are cataloged by project name, description, and numerous other attributes.

### Available Data Sources
A JSON formatted list (object property: sources) of _name_ & _id_ of all currently available data sources and their properties may be obtained via URI:
```
api/v1/source
```

_warehouse_ source, supporting cross-datasource queries is not currently available.

## Sensitive Data
Some data sources may be restricted from general public release for confidentiality reasons. 

#### Login
Session login is available via NOAA CAC "ID" certificate through NOAA Single-Sign-On URL:
```
https://sso.lb.csp.noaa.gov/openam/saml2/jsp/idpSSOInit.jsp?spEntityID=https://www.nwfsc.noaa.gov/data/api/v1/saml/metadata/&metaAlias=/noaa-online/noaa-online-idp&RelayState=https://www.nwfsc.noaa.gov/data
```

Successful login will set "api.session.id" cookie. Session times out after 90 minutes, cookie is valid for 90 days.

The URL `RelayState` parameter is optional, or can be changed to another useful API URL (e.g.: `&RelayState=https://www.nwfsc.noaa.gov/data/api/v1/user`)

#### Authorization
Access to sensitive datasets is provided to logged in users via registration of applicable Non Disclosure Agreements with the data owner & [FRAM data team](mailto:nmfs.nwfsc.fram.data@noaa.gov).

#### User info
Information about the current user session is available via URI:
```
api/v1/user
```

#### Logout
Session logout is available via URI:
```
api/v1/logout
```

#### Non-NOAA Users
Session login for external, Non-NOAA users is also available via HTTP POST of parameters 'username','password' to URI:
```
api/v1/external/login
```

For account creation, please contact [FRAM data team](mailto:nmfs.nwfsc.fram.data@noaa.gov).

##### Login Example
Below is an example, of how to access sensitive API data using Curl.
* obtain a login cookie, by HTTP POST to `api/v1/external/login`
  - Example command:

    `curl -X POST --data-urlencode "username=nmfs.nwfsc.fram.data.team+pacfin@noaa.gov" --data-urlencode "password=secret" --silent -k https://nwcdevfram.nwfsc.noaa.gov/api/v1/external/login --cookie-jar -`

  - Example output:

            # Netscape HTTP Cookie File
            # https://curl.haxx.se/docs/http-cookies.html
            # This file was generated by libcurl! Edit at your own risk.
            
            nwcdevfram.nwfsc.noaa.gov       FALSE   /       FALSE   1533659706      api.session.id  50a6d0d581da4fc9a6db120fde87e0d7
* sending the login cookie value, to see the current [user info](#user-info)
  - Example command:

    `curl -X GET --cookie "api.session.id=50a6d0d581da4fc9a6db120fde87e0d7" --silent -k https://nwcdevfram.nwfsc.noaa.gov/api/v1/user`
    
  - Example output:

            {"user": {"id": "uid=nmfs.nwfsc.fram.data.team+pacfin@noaa.gov,ou=People,o=warehouse-external", "description": "Authenticated user."}}

* sending the login cookie, to [download data](#data-selection)
  - Example command:

    `curl -X GET --cookie "api.session.id=50a6d0d581da4fc9a6db120fde87e0d7" --output mydata.csv --silent -k https://nwcdevfram.nwfsc.noaa.gov/api/v1/source/observer.catch_observer_fact_conf/selection.csv`

* sending the login cookie, to [end login session](#logout)
  - Example command:

    `curl -X GET --cookie "api.session.id=50a6d0d581da4fc9a6db120fde87e0d7" --silent -k https://nwcdevfram.nwfsc.noaa.gov/api/v1/logout`

  - Example output:

            {"title": "Session closed", "description": "Done. Session logged out for: uid=nmfs.nwfsc.fram.data.team+pacfin@noaa.gov,ou=People,o=warehouse-external"}

#### SAML2
Login is performed via SAML2, which is implemented via URI:
```
api/v1/saml
```

#### SAML2 Metadata
SAML2 Service Provider metadata for the API is available via URI:
```
api/v1/saml/metadata
```

Service Provider metadata is used to configure a different SAML2 Identitity Provider (See your Identity provider for details on what the new Single-Sign-On URL will be).

#### Login (LDAP)
(Deprecated) Session login with NOAA LDAP credentials, is also available via HTTP POST of parameters 'username','password' to URI:
```
api/v1/login
```

## API Documentation

The current version of this documentation (HTML-formatted) may be obtained via URI:
```
api/v1/help
```

## Privacy Information

A machine-readable P3P ([Platform for Privacy Preferences](https://www.w3.org/P3P/)) Policy Reference File may be obtained via URI.
```
api/v1/p3p.xml
```

### Privacy Information Header
Machine-readable privacy reference information is also available with every API response, via HTTP header: P3P

## OGC Catalog Service for the Web (CSW)

The contents of the FRAM Warehouse are discoverable through a [CSW compliant](http://www.opengeospatial.org/standards/cat) XML webservice [provided via (PyCSW)](http://pycsw.org/), accessable via URI:
```
api/v1/csw
api/v1/csw?service=CSW&version=2.0.2&request=GetCapabilities
```

## Data Selection

A formatted selection of the information contained in a data source, may be obtained by substituting the _id_ of the desired source and _format_ of output in place of _{source_id}_ & _{format}_ in the below URI:
```
api/v1/source/{source_id}/selection.{format}
```

#### Supported Output Formats
The following format ids are available for selection output:

* json -- JavaScript Object Notation text [ECMA-404 JSON Data Interchange Standard](http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf)
* csv -- Comma Separated Values text (Excel-compatible)

### Selection Parameters
Selection supports four RESTful HTTP query parameters:

* [variables](#Subsetting)
* [defaults](#subsetting-defaults)
* [filters](#Advanced-Filtering)
* [empty_cells](#Select-Empty-Cells)
* [pivot_columns](#Pivot-selection)

Selection additionally supports the name of any data source field, as an HTTP query parameter that performs simple equality-filtering.
* [{data source field name}](#Filtering)

For more information on use of ampersand ("&") separated field-value pairs and HTTP query strings [see wikipedia.org](https://en.wikipedia.org/wiki/Query_string#Structure).

### Subsetting

A subset of the available Data source variables may be obtained by specifying a _variables_ URL query parameter.
Default:
Service will default to retrieving **All** variables if no _variables_ parameter is provided (or _variables_ is provided but without naming any variables) and if Warehouse administrators have not [defined any defaults|#subsetting-defaults].
```
api/v1/source/{source_id}/selection.json?variables={name1}
api/v1/source/{source_id}/selection.json?variables={name1},{name2} ... ,{nameN}
```

#### Available Data source variables

A JSON formatted list (object property: variables) of _id_ of all currently available variables for a data source may be obtained via URI:
```
api/v1/source/{source_id}/variables
```

### Subsetting Defaults
Predefined, curated sets of variables (defined & named by Warehouse administrators) for a dataset may be requested via the _defaults_ query parameter.
Default:
Service will default to retrieving the "core" defaults, "expanded" defaults, any single named defaults, or **All** variables (in that order) if no _defaults_ parameter is provided, or if _defaults_ is provided but without specifying a value.
```
api/v1/source/{source_id}/selection.json?defaults={core|expanded}
api/v1/source/{source_id}/selection.json?defaults={customDatasetDefault1}
```

#### Subsetting by Dataset
The 'warehouse' data source represents a fusion of multiple data sources. As a supplement to the _variables_ URL query parameter a subset including **all** variables from one or more of these underlaying data sources may be specified via _datasets_ query parameter:
```
api/v1/source/{source_id}/selection.json?datasets={source_id1}
api/v1/source/{source_id}/selection.json?datasets={source_id1},{source_id2} ... ,{source_idN}
```

### Filtering

Simple filtering may be performed by specifying the name of a data set variable as a URL query parameter.
```
api/v1/source/{source_id}/selection.json?{fieldName1=value1}
api/v1/source/{source_id}/selection.json?{fieldName1=value1}&{fieldName2=value2} ... &{fieldNameN=valueN}
```

Simple union (OR) selection filtering, within a single data set variable, may be performed by specifying two or more comma-separated values.
```
api/v1/source/{source_id}/selection.json?{fieldName1=value1,value2}
api/v1/source/{source_id}/selection.json?{fieldName1=value1}&{fieldName2=value2.0,value2.1} ... &{fieldNameN=valueN}
```

#### Advanced Filtering

The selection may be filtered by specifying a _filters_ URL query parameter defining one or more comma-delimited filtering statements.
A filter may reference any data set variable, even a variable not included in the requested subset e.g.: ?variables=pacfin_code,common_name&filters=season_year=2012;
```
api/v1/source/{source_id}/selection.json?filters={name1=value1}
api/v1/source/{source_id}/selection.json?filters={name1=value1},{name2=value2} ... ,{nameN=valueN}
```

##### Supported Filter Operations

* {variable} = {value}
* {variable} > {value}
* {variable} < {value}
* {variable} >= {value}
* {variable} <= {value}
* {variable} != {value}
* {variable} ~= {value}
* {variable} |= {value}

 1. '~=' provides Regular Expression matching e.g.:
  * _filters=MyFieldName~=321_ - matches any occurence of '321' in the field's text
  * _filters=MyFieldName~=\^321$_ matches any row with exactly value '321' in the field
  * _filters=MyFieldName~=\^(321)|(987)$_ matches any row with exactly value '321' in the field or value '987'
 2. '|=' provides OR matching with robust type support, via an urlencoded-comma (%2C) separated list of quoted string values enclosed in square brackets e.g.:
  * _filters=MyFieldName|=["321"] - matches any record with exactly a value of 321 (converted from a string, into the type of the field).
  * _filters=MyFieldName|=["321"%2C"987"] - matches any records with an exact value of either 321 or 987.

### Select Empty Cells

Selection implementation defaults to suppression of empty cells which would result from the intersection of two Dimensional values (e.g.: Longitude and Depth) for which there is no measured value. To obtain a data set selection with all possible values for one or more Dimensions, provide a list of desired dimension names via the _empty_cells_ URL query parameter:
```
api/v1/source/{source_id}/selection.json?empty_cells={name1}
api/v1/source/{source_id}/selection.json?empty_cells={name1},{name2} ... ,{nameN}
```

The _empty_cells_ query parameter is not compatible with Dimensional data source selections. Direct selection from a Dimensional data source always returns all possible dimensional values.

### Pivot selection

Pivoted (Crosstab) selection output may be generated by specifiying a _pivot_columns_ URL query parameter.
```
api/v1/source/{source_id}/selection.json?pivot_columns={name1}
api/v1/source/{source_id}/selection.json?pivot_columns={name1},{name2} ... ,{nameN}
```

Pivot selection may not be available for some (Dimensional) data sources. Dimensional data sources contain no measured values to pivot over, instead containing only a dictionary or range of possible values defined by a project.

Selection output will replace all _pivot_columns_ variables and all data variables with generated pivot-breakdowns for all data variables. Format for the generated pivot column headings is:
```
{dataVariableName}({aggregationMethodUsed}) {pivotVariable1-Name}({pivotVariable1-Value}) [{pivotVariable2-Name}({pivotVariable2-Value}) ... {pivotVariableN-Name}({pivotVariableN-Value})
```
The _aggregationMethodUsed_ is automatically determined by the type of _dataVariableName_
 * 'sum' is used for data variables of type: int, float
 * 'count' is used for data variables of type: string, datetime

## Data Set Metadata

A NMFS/FIS InPort XML Format metadata document may be obtained for each data source via URI:
```
api/v1/source/{source_id}/metadata.xml
```

For more information on contents & usage, see: [https://inport.nmfs.noaa.gov/inport/help/xml-loader](https://inport.nmfs.noaa.gov/inport/help/xml-loader#the-inport-xml-format)

#### ISO-19139
ISO:19139 Geographic MetaData (GMD) formatted metadata may be obtained for each data source via URI:
```
api/v1/source/{source_id}/metadata.iso
```

Alternatively ISO metadata may be obtained via OGC Catalog Service - Web (CSW) compatible interface. See [OGC Catalog Service for the Web (CSW)](#ogc-catalog-service-for-the-web-csw).

#### Copyright 2015-2018 ERT, Inc. All Rights reserved
